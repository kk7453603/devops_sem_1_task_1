FROM ubuntu:22.04

LABEL maintainer="DevOps Lab"
LABEL description="Nginx –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
    nginx \
    curl \
    wget \
    && rm -rf /var/lib/apt/lists/*

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
RUN mkdir -p /var/www/html /var/log/nginx /var/cache/nginx

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ nginx –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
RUN chown -R www-data:www-data /var/www/html && \
    chown -R www-data:www-data /var/log/nginx

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx
COPY ansible/roles/nginx/templates/nginx.conf.j2 /tmp/default.conf

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —à–∞–±–ª–æ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–∑–∞–º–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö)
RUN envsubst < /tmp/default.conf > /etc/nginx/sites-available/default

# –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–π —Å—Å—ã–ª–∫–∏
RUN ln -sf /etc/nginx/sites-available/default /etc/nginx/sites-enabled/

# –£–¥–∞–ª–µ–Ω–∏–µ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã nginx
RUN rm -f /var/www/html/index.nginx-debian.html

# –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
RUN echo '<!DOCTYPE html><html><head><title>DevOps Lab</title></head><body><h1>üöÄ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ DevOps –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—é!</h1><p>Nginx —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç!</p><p><a href="/app/">–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é</a></p></body></html>' > /var/www/html/index.html

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
RUN ln -sf /dev/stdout /var/log/nginx/access.log && \
    ln -sf /dev/stderr /var/log/nginx/error.log

# –≠–∫—Å–ø–æ—Ä—Ç –ø–æ—Ä—Ç–∞ 80
EXPOSE 80

# –ó–∞–ø—É—Å–∫ nginx
CMD ["nginx", "-g", "daemon off;"]