FROM ubuntu:22.04

LABEL maintainer="DevOps Lab"
LABEL description="–ß–∏—Å—Ç—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ nginx —á–µ—Ä–µ–∑ Ansible"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–±–µ–∑ nginx)
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    net-tools \
    iputils-ping \
    dnsutils \
    systemd \
    sudo \
    openssh-server \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH —Å–µ—Ä–≤–µ—Ä–∞
RUN mkdir /var/run/sshd && \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
    echo 'root:ansible' | chpasswd

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è nginx (–±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã Ansible)
RUN mkdir -p /var/www/html /var/log/nginx /var/cache/nginx

# –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
RUN echo '<!DOCTYPE html><html><head><title>DevOps Lab</title></head><body><h1>üöÄ –ß–∏—Å—Ç—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥–æ—Ç–æ–≤ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ!</h1><p>Nginx –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ Ansible.</p></body></html>' > /var/www/html/index.html

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
RUN chown -R www-data:www-data /var/www/html && \
    chown -R www-data:www-data /var/log/nginx

# –≠–∫—Å–ø–æ—Ä—Ç –ø–æ—Ä—Ç–æ–≤ SSH –∏ HTTP
EXPOSE 22 80

# –ó–∞–ø—É—Å–∫ SSH —Å–µ—Ä–≤–µ—Ä–∞ –∏ –æ–∂–∏–¥–∞–Ω–∏–µ Ansible
CMD ["/usr/sbin/sshd", "-D"]